#!/usr/bin/env python
# -*- coding: utf-8 -*-

from werkzeug.middleware.dispatcher import DispatcherMiddleware
from werkzeug.middleware.proxy_fix import ProxyFix
from werkzeug.middleware.http_proxy import ProxyMiddleware
from werkzeug.exceptions import NotFound

from app.wsgi import app as backend

def unshift_path_info(app, prefix):
    """
    Decorator to un-shift a path?  The reason is that
    DispatcherMiddleWare strips the prefix.  That is:

         PATH_INFO          SCRIPT_NAME   PATH_INFO
         /api/v1/greet  =>  /api          v1/greet

    And we're going to squash 'em... it's kind of stupid tbh.
    """
    def wrapper(environ, start_response):
        script_name = environ.get('SCRIPT_NAME', '')
        if script_name:
            path_info = environ.get('PATH_INFO', '')
            environ['PATH_INFO'] = script_name + path_info
        return app(environ, start_response)
    return wrapper

app = DispatcherMiddleware(
    ProxyMiddleware(
        NotFound(), {
            "/": {
                "target": "http://localhost:5173/",
            }
        }
    ), {
        "/api": unshift_path_info(backend, '/api'),
    }
)

if __name__ == "__main__":
    from werkzeug.serving import run_simple
    run_simple("127.0.0.1", 8080, app, use_reloader=True, use_debugger=True)
