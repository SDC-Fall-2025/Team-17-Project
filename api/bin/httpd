#!/usr/bin/env python
# -*- coding: utf-8 -*-

from werkzeug.wrappers import Request, Response
from werkzeug.serving import run_simple
from werkzeug.middleware.dispatcher import DispatcherMiddleware
from werkzeug.middleware.proxy_fix import ProxyFix
from werkzeug.middleware.http_proxy import ProxyMiddleware

# 1️⃣  our local flask app (WSGI)
from app.wsgi import app

# 2️⃣  proxy config
vite_proxy = ProxyMiddleware(
    None,
    {
        "/": {
            "target": "http://127.0.0.1:5173/",
            "strip_path": False,
        }
    },
)

# mount Flask first, then fallback to vite
application = DispatcherMiddleware(vite_proxy, {
    "/api": app
})

# optional: makes X-Forwarded headers behave correctly
application = ProxyFix(application)

if __name__ == "__main__":
    run_simple("127.0.0.1", 8080, application, use_reloader=True, use_debugger=True)
